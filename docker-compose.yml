name: mvbar

services:
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      TZ: Europe/London

      # internal (single-container) connection strings
      DATABASE_URL: postgresql://mvbar:mvbar@127.0.0.1:5432/mvbar
      REDIS_URL: redis://127.0.0.1:6379
      MEILI_HOST: http://127.0.0.1:7700
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}

      # app config
      JWT_SECRET: ${JWT_SECRET}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      TRUST_PROXY: ${TRUST_PROXY:-true}
      COOKIE_SECURE: ${COOKIE_SECURE:-auto}
      COOKIE_NAME: ${COOKIE_NAME:-mvbar_token}
      APP_DOMAIN: ${APP_DOMAIN:-}
      LASTFM_API_KEY: ${LASTFM_API_KEY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:-}

      # worker
      MUSIC_DIRS: /music
      TEMPO_DETECT: ${TEMPO_DETECT:-0}
      TEMPO_MODE: ${TEMPO_MODE:-batch}
      TEMPO_METHOD: ${TEMPO_METHOD:-energy}
      TEMPO_MIN_CONF: ${TEMPO_MIN_CONF:-0.35}
      TEMPO_CONCURRENCY: ${TEMPO_CONCURRENCY:-2}
      TEMPO_BACKFILL_INTERVAL_MS: ${TEMPO_BACKFILL_INTERVAL_MS:-1800000}
      TEMPO_BACKFILL_BATCH: ${TEMPO_BACKFILL_BATCH:-50}

      # web -> api internal calls
      API_INTERNAL_BASE: http://127.0.0.1:3001

    volumes:
      # mount your music (edit these)
      - /path/to/music:/music:ro
      #- /path/to/music2:/music2:ro

      # persistent data
      - pg:/var/lib/postgresql/data
      - redis:/data/redis
      - meili:/meili_data
      - caddy_data:/data/caddy
      - caddy_config:/config/caddy
      - cache:/data/cache
      - hls:/hls
      - podcasts:/podcasts

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/health >/dev/null"]
      interval: 10s
      timeout: 5s
      retries: 15

volumes:
  pg:
  redis:
  meili:
  caddy_data:
  caddy_config:
  cache:
  hls:
  podcasts:
